<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Knowledge Bases - KB Codex</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
</head>
<body>
  <div id="app">
    <nav class="navbar navbar-light bg-light mb-4">
      <div class="container-fluid">
        <span class="navbar-brand mb-0 h1">KB Codex</span>
      </div>
    </nav>
    <div class="container">
      <h1 class="mb-4">Knowledge Bases</h1>
      <ul class="list-group mb-4">
        <li v-for="kb in kbs" :key="kb.id" class="list-group-item list-group-item-action" @click="selectKB(kb)">{{ kb.name }}</li>
      </ul>
      <form @submit.prevent="createKB" class="row g-2 mb-4">
        <div class="col-auto flex-grow-1">
          <input v-model="newKBName" type="text" class="form-control" placeholder="New KB name" required />
        </div>
        <div class="col-auto">
          <button type="submit" class="btn btn-success">Create KB</button>
        </div>
      </form>
      <div v-if="selectedKB" class="mb-5">
        <h2 class="mb-3">Upload to {{ selectedKB.name }}</h2>
        <div class="input-group mb-3">
          <input type="file" class="form-control" @change="onFileChange" accept=".txt,.md" />
          <button class="btn btn-primary" @click="uploadFile">Upload File</button>
        </div>
        <div class="mb-3">
          <div class="border rounded p-3 text-center"
            :class="{'bg-info bg-opacity-25': isDragging}"
            @dragenter.prevent="isDragging = true"
            @dragover.prevent="onDragOver"
            @dragleave="isDragging = false"
            @drop.prevent="handleDrop">
            Drag &amp; drop .txt or .md file here
          </div>
        </div>
        <h3>Files</h3>
        <ul class="list-group">
          <li v-for="file in files" :key="file" class="list-group-item">{{ file }}</li>
        </ul>
      </div>
    </div>
  </div>
  <script>
    const { createApp } = Vue;
    createApp({
      data() {
        return {
          kbs: [],
          newKBName: '',
          selectedKB: null,
          files: [],
          selectedFile: null,
          isDragging: false,
        };
      },
      mounted() {
        this.fetchKBs();
      },
      methods: {
        async fetchKBs() {
          const res = await fetch('/api/kbs');
          this.kbs = await res.json();
        },
        async createKB() {
          await fetch('/api/kbs', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: this.newKBName }),
          });
          this.newKBName = '';
          this.fetchKBs();
        },
        selectKB(kb) {
          this.selectedKB = kb;
          this.fetchFiles();
        },
        async fetchFiles() {
          if (!this.selectedKB) return;
          const res = await fetch(`/api/kbs/${this.selectedKB.id}/files`);
          this.files = await res.json();
        },
        onFileChange(event) {
          this.selectedFile = event.target.files[0];
        },
        async uploadFile() {
          if (!this.selectedKB || !this.selectedFile) return;
          const form = new FormData();
          form.append('file', this.selectedFile);
          await fetch(`/api/kbs/${this.selectedKB.id}/files`, { method: 'POST', body: form });
          this.selectedFile = null;
          this.fetchFiles();
        },
        onDragOver(event) {
          event.dataTransfer.dropEffect = 'copy';
          this.isDragging = true;
        },
        async handleDrop(event) {
          this.isDragging = false;
          const files = event.dataTransfer.files;
          if (files && files.length > 0) {
            this.selectedFile = files[0];
            await this.uploadFile();
          }
        },
      }
    }).mount('#app');
  </script>
</body>
</html>